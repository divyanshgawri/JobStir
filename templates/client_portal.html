
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobStir - Candidate Portal</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/client_portal.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 color=%22white%22>JB</text></svg>" />
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-X4H5RPBG76"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X4H5RPBG76');

  // Send a test event after page loads
  window.addEventListener("load", function () {
    gtag('event', 'resume_upload_test', {
      method: 'manual_trigger',
      page_location: window.location.href,
      page_title: document.title
    });
    console.log("âœ… Test event 'resume_upload_test' sent to GA");
  });
</script>

</head>
<body>
    <div class="container">
        <header class="client-portal-header">
            <h1>Your Applications</h1>
            <div class="action-buttons">
                <a href="{{ url_for('index') }}" class="btn-back-home">Home</a>
                <a href="{{ url_for('candidate_apply') }}" class="btn-back-home">Browse Jobs</a>
                <a href="{{ url_for('logout') }}" class="btn-back-home btn-danger">Logout</a>
            </div>
        </header>

        <main>
            {% if applications %}
                <div class="card-carousel-container">
                    <button id="prevCardBtn" class="carousel-nav-btn prev-btn hidden">&lt; Previous</button>
                    <div class="application-cards-list">
                        {% for app in applications %}
                            <div class="application-card {% if loop.first %}active{% endif %}">
                                <h2>Applied for: <strong>{{ app.job_title | default('Unknown Job') }}</strong> at {{ app.company_name | default('Unknown Company') }}</h2>

                                <div class="card-status-section">
                                    <h4>
                                        Status:
                                        <span class="eligibility-status-badge status-{{ app.eligibility_status | lower | replace(' ', '-') | replace('(', '') | replace(')', '') | default('pending') }}">
                                            {{ app.eligibility_status | default('Pending') }}
                                        </span>
                                    </h4>
                                    <span class="submission-date">Submitted: {{ app.submission_date | default('Not available') }}</span>
                                </div>

                                <div class="card-body">
                                    <p class="match-score-text">AI Match Score: 
                                        <span class="score-value">{{ app.match_score | default('N/A') }}%</span>
                                    </p>

                                    <div class="reason-feedback-box">
                                        <h4>Reasoning & Areas for Improvement</h4>
                                        <p>{{ app.eligibility_reason | default('No feedback available at this time.') }}</p>
                                    </div>
                                </div>

{% if app.eligibility_status == 'Recommended' and app.exam_questions %}
    {% if not app.exam_taken %}
        <a class="btn-take-exam" 
           href="{{ url_for('get_exam', job_id=app.job_id, candidate_id=app.id) }}">
            Take Your Technical Exam
        </a>
    {% elif app.exam_taken %}
        <div class="exam-results-card">
            <h3>Exam Results</h3>
            <p>Total Score: <span class="font-bold">{{ app.exam_score | default('N/A') }} / 30</span></p>
            
            {% if app.exam_feedback %}
                <div class="collapsible-container">
                    <div class="collapsible-header">
                        <span>View Detailed Exam Feedback</span>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                    <div class="collapsible-content hidden">
                        <ul class="exam-feedback-list">
                            {% for feedback_item in app.exam_feedback %}
                                <li>
                                    <strong>Question:</strong> {{ feedback_item.question | default('N/A') }} <br>
                                    <strong>Score:</strong> {{ feedback_item.score | default('N/A') }}/10 <br>
                                    <strong>Feedback:</strong> {{ feedback_item.feedback | default('No feedback provided') }}
                                </li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            {% else %}
                <p>No detailed exam feedback available.</p>
            {% endif %}
        </div>
    {% endif %}  
{% endif %}


                                <div class="collapsible-container">
                                    <div class="collapsible-header active">
                                        <span>View Your Submitted Resume Details</span>
                                        <i class="fas fa-chevron-up"></i>
                                    </div>
                                    <div class="collapsible-content">
                                        {% set info = app.extracted_info | default({}) %}
                                        
                                        <div class="info-section">
                                            <h5>Contact Information</h5>
                                            <p><strong>Name:</strong> {{ info.name | default('Not provided') }}</p>
                                            <p><strong>Email:</strong> {{ info.email | default('Not provided') }}</p>
                                            <p><strong>Phone:</strong> {{ info.phone | default('Not provided') }}</p>
                                        </div>
                                        
                                        <div class="info-section">
                                            <h5>Experience</h5>
                                            {% if info.experience %}
                                                <ul>
                                                    {% for exp in info.experience %}
                                                        <li>
                                                            <strong>{{ exp.title | default('Role Unknown') }}</strong> at 
                                                            {{ exp.location | default('Unknown Company') }} 
                                                            ({{ exp.duration | default('Not provided') }})
                                                            {% if exp.description %}
                                                                <ul class="exp-description">
                                                                    {% for desc in exp.description %}
                                                                        <li>{{ desc }}</li>
                                                                    {% endfor %}
                                                                </ul>
                                                            {% endif %}
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p>No experience details provided.</p>
                                            {% endif %}
                                        </div>

                                        <div class="info-section">
    <h5>Skills</h5>
    {% if info.skills %}
        <ul>
            {% for skill in info.skills %}
                <li>{{ skill }}</li>
            {% endfor %} 
        </ul>
    {% else %}
        <p>No skills listed.</p>
    {% endif %}
</div>
                                        <div class="info-section">
                                            <h5>Projects</h5>
                                            {% if info.projects %}
                                                <ul>
                                                    {% for project in info.projects %}
                                                        <li>
                                                            <strong>{{ project.title | default('Untitled Project') }}</strong>
                                                            {% if project.link != '[Link]' %}
                                                                (<a href="{{ project.link }}" class="text-link" target="_blank">Link</a>)
                                                            {% endif %}
                                                            <ul class="project-description">
                                                                {% for desc in project.description %}
                                                                    <li>{{ desc }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        </li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p>No projects listed.</p>
                                            {% endif %}
                                        </div>

                                        <div class="info-section">
                                            <h5>Education</h5>
                                            {% if info.education %}
                                                <ul>
                                                    {% for edu in info.education %}
                                                        <li>{{ edu.degree }} - {{ edu.university }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p>No education details provided.</p>
                                            {% endif %}
                                        </div>

                                        <div class="info-section">
    <h5>Achievements</h5>
    {% if info.achievements and info.achievements | length > 0 and info.achievements[0] != 'No achievements listed.' %}
        <ul>
            {% for achievement in info.achievements %}
                <li>{{ achievement }}</li>
            {% endfor %}
        </ul>
    {% endif %} 
</div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <button id="nextCardBtn" class="carousel-nav-btn next-btn {% if applications|length <= 1 %}hidden{% endif %}">Next &gt;</button>
                </div>
            {% else %}
                <div class="empty-state">
                    <h2>No Applications Found</h2>
                    <p>You have not submitted any applications yet. Find a job to get started!</p>
                    <a href="{{ url_for('index') }}" class="btn-primary">Browse Jobs</a>
                </div>
            {% endif %}


    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Carousel Logic
            const applicationCards = document.querySelectorAll('.application-card');
            const prevBtn = document.getElementById('prevCardBtn');
            const nextBtn = document.getElementById('nextCardBtn');
            let currentCardIndex = 0;

            function showCard(index) {
                if (applicationCards.length === 0) return;
                applicationCards.forEach((card, i) => {
                    card.classList.toggle('active', i === index);
                });
                if (prevBtn) prevBtn.classList.toggle('hidden', index === 0);
                if (nextBtn) nextBtn.classList.toggle('hidden', index >= applicationCards.length - 1);
            }

            if (applicationCards.length > 0) {
                showCard(currentCardIndex);
            }

            if (nextBtn) {
                nextBtn.addEventListener('click', () => {
                    if (currentCardIndex < applicationCards.length - 1) {
                        currentCardIndex++;
                        showCard(currentCardIndex);
                    }
                });
            }

            if (prevBtn) {
                prevBtn.addEventListener('click', () => {
                    if (currentCardIndex > 0) {
                        currentCardIndex--;
                        showCard(currentCardIndex);
                    }
                });
            }

            // Collapsible Sections Logic
            document.querySelectorAll('.collapsible-header').forEach(header => {
                header.addEventListener('click', () => {
                    header.classList.toggle('active');
                    const content = header.nextElementSibling;
                    content.classList.toggle('hidden');
                    const icon = header.querySelector('i');
                    if (icon) {
                        icon.classList.toggle('fa-chevron-down');
                        icon.classList.toggle('fa-chevron-up');
                    }
                });
            });

            // Auto-expand active collapsible sections
            document.querySelectorAll('.collapsible-header.active').forEach(header => {
                const content = header.nextElementSibling;
                content.classList.remove('hidden');
                const icon = header.querySelector('i');
                if (icon) {
                    icon.classList.remove('fa-chevron-down');
                    icon.classList.add('fa-chevron-up');
                }
            });

            // Exam Modal Logic
            const examModal = document.getElementById('examModal');
            const examQuestionsContainer = document.getElementById('examQuestions');
            const examMessageBox = document.getElementById('examMessageBox');
            const closeModalBtn = document.querySelector('.close-button');
            const submitModalBtn = document.querySelector('.btn-submit-modal');
            const cancelModalBtn = document.querySelector('.btn-cancel');

            document.querySelectorAll('.btn-take-exam').forEach(button => {
                button.addEventListener('click', async () => {
                    const jobId = button.dataset.jobId;
                    const applicationId = button.dataset.applicationId;

                    if (!jobId || !applicationId) {
                        examMessageBox.className = 'message-error';
                        examMessageBox.textContent = 'Error: Missing job or application ID.';
                        examModal.classList.add('visible');
                        return;
                    }

                    try {
                        const response = await fetch(`/get_exam?job_id=${jobId}&candidate_id=${applicationId}`);
                        const data = await response.json();

                        if (data.error) {
                            examMessageBox.className = 'message-error';
                            examMessageBox.textContent = data.error;
                            examModal.classList.add('visible');
                            return;
                        }

                        examQuestionsContainer.innerHTML = '';
                        data.questions.forEach((q, index) => {
                            const questionDiv = document.createElement('div');
                            questionDiv.className = 'question-item';
                            questionDiv.innerHTML = `
                                <p>${index + 1}. ${q.question || 'Question not available'}</p>
                                <textarea rows="4" name="answer_${index}"></textarea>
                            `;
                            examQuestionsContainer.appendChild(questionDiv);
                        });

                        examModal.classList.add('visible');
                    } catch (error) {
                        examMessageBox.className = 'message-error';
                        examMessageBox.textContent = 'Failed to load exam questions.';
                        examModal.classList.add('visible');
                    }
                });
            });

            if (closeModalBtn) {
                closeModalBtn.addEventListener('click', () => {
                    examModal.classList.remove('visible');
                    examQuestionsContainer.innerHTML = '';
                    examMessageBox.textContent = '';
                    examMessageBox.className = '';
                });
            }

            if (cancelModalBtn) {
                cancelModalBtn.addEventListener('click', () => {
                    examModal.classList.remove('visible');
                    examQuestionsContainer.innerHTML = '';
                    examMessageBox.textContent = '';
                    examMessageBox.className = '';
                });
            }

            if (submitModalBtn) {
                submitModalBtn.addEventListener('click', async () => {
                    const answers = Array.from(examQuestionsContainer.querySelectorAll('textarea')).map(textarea => textarea.value);
                    const jobId = document.querySelector('.btn-take-exam')?.dataset.jobId;
                    const applicationId = document.querySelector('.btn-take-exam')?.dataset.applicationId;

                    if (!jobId || !applicationId) {
                        examMessageBox.className = 'message-error';
                        examMessageBox.textContent = 'Error: Missing job or application ID.';
                        return;
                    }

                    try {
                        const response = await fetch('/submit_exam', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ job_id: jobId, candidate_id: applicationId, answers })
                        });
                        const result = await response.json();

                        examMessageBox.className = result.success ? 'message-success' : 'message-error';
                        examMessageBox.textContent = result.message;
                        if (result.success) {
                            setTimeout(() => {
                                examModal.classList.remove('visible');
                                location.reload();
                            }, 2000);
                        }
                    } catch (error) {
                        examMessageBox.className = 'message-error';
                        examMessageBox.textContent = 'Failed to submit exam answers.';
                    }
                });
            }
        });
        
    </script>
</body>
</html>