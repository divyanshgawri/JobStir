<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>JobStir - Your Applications</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âœ¨</text></svg>" />
    <link rel="stylesheet" href="{{url_for('static', filename='css/client_portal.css')}}">
    {# Link to Font Awesome for icons if used (e.g., for chevron down/up) #}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <div class="page-wrapper">
        <header class="client-portal-header">
            <h1>Your Applications</h1>
            <a href="{{ url_for('index') }}" class="btn-back-home">
                Back to Home
            </a>
        </header>

        <main>
            {% if applications %}
                <div class="card-carousel-container">
                    <button id="prevCardBtn" class="carousel-nav-btn prev-btn hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
                        </svg>
                        Previous
                    </button>
                    <div class="application-cards-list">
                        {% for app in applications %}
                            <div class="application-card {% if loop.index == 1 %}active{% endif %}">
                                <h2>
                                    Applied for: {{ app.job_title }} at {{ app.company_name }}
                                </h2>
                                <div class="card-status-section">
                                    <h4>
                                        Your Status:
                                        <span class="eligibility-status-badge
                                            {% if app.eligibility_status == 'Eligible' %}eligible
                                            {% else %}not-eligible{% endif %}">
                                            {{ app.eligibility_status }}
                                        </span>
                                    </h4>
                                    <span class="submission-date">Submitted: {{ app.submission_date }}</span>
                                </div>

                                <div class="mb-4">
                                    <p class="match-score-text">Match Score: 
                                        <span class="score-value">{{ app.match_score if app.match_score is not none else 'N/A' }}%</span>
                                    </p>

                                    {% if app.eligibility_status == 'Not Eligible' %}
                                        <div class="reason-feedback-box error">
                                            <h4>Reason for Non-Selection & Areas for Improvement:</h4>
                                            <p class="leading-relaxed">{{ app.eligibility_reason }}</p>
                                        </div>
                                    {% endif %}
                                </div>

                                {# MODIFIED: Exam button logic #}
                                {% if app.eligibility_status == 'Eligible' %}
                                    {# Check if exam_questions exist (means exam could be generated) #}
                                    {% if app.exam_questions %}
                                        {% if not app.exam_taken %}
                                            {# Button that triggers JavaScript redirect to get_exam #}
                                            <button class="btn-take-exam"
                                                    data-job-id="{{ app.job_id }}" data-candidate-id="{{ app.id }}"> {# Use app.id here #}
                                                Take Exam
                                            </button>
                                        {% else %}
                                            <div class="exam-results-card">
                                                <h3>Exam Results:</h3>
                                                <p>Total Score: <span class="font-bold">{{ app.exam_score }} / 30</span></p>
                                                {# Collapsible section for Exam Feedback #}
                                                <!-- {% if app.exam_feedback %}
                                                    <div class="collapsible-container">
                                                        <div class="collapsible-header">
                                                            <span>View Detailed Exam Feedback <i class="fas fa-chevron-down"></i></span>
                                                        </div>
                                                        <div class="collapsible-content hidden">
                                                            <ul class="exam-feedback-list">
                                                                {% for feedback_item in app.exam_feedback %}
                                                                    <li>
                                                                        <strong>Q:</strong> {{ feedback_item.question }} <br>
                                                                        <strong>Score:</strong> {{ feedback_item.score }}/10<br>
                                                                        <strong>Feedback:</strong> {{ feedback_item.feedback }}
                                                                    </li>
                                                                {% endfor %}
                                                            </ul>
                                                        </div>
                                                    </div>
                                                {% else %}
                                                    <p class="text-muted">No detailed feedback available.</p>
                                                {% endif %} -->
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-yellow-600 mt-4">Exam questions not yet generated or failed to generate. Please check back later.</p>
                                    {% endif %}
                                {% endif %}

                                {# Collapsible section for Resume Details #}
                                <div class="collapsible-container">
                                    <div class="collapsible-header">
                                        <span>View Your Resume Details </span>
                                    </div>
                                    <div class="collapsible-content hidden">
                                        {% set info = app.extracted_info %}
                                        
                                        {% if info.email or info.phone %}
                                        <div class="info-section">
                                            <h5>Contact Information</h5>
                                            {% if info.email %}<p><strong>Email:</strong> {{ info.email }}</p>{% endif %}
                                            {% if info.phone %}<p><strong>Phone:</strong> {{ info.phone }}</p>{% endif %}
                                        </div>
                                        {% endif %}

                                        {% if info.education %}
                                        <div class="info-section">
                                            <h5>Education</h5>
                                            <ul>
                                                {% for edu in info.education %}
                                                    <li>
                                                        <strong>{{ edu.degree if edu.degree else 'N/A' }}</strong> from {{ edu.university if edu.university else 'N/A' }}
                                                        {% if edu.start_year or edu.end_year %}
                                                            ({{ edu.start_year if edu.start_year else '' }} - {{ edu.end_year if edu.end_year else 'Present' }})
                                                        {% endif %}
                                                        {% if edu.concentration %}<p>Concentration: {{ edu.concentration }}</p>{% endif %}
                                                        {% if edu.cumulative_gpa %}<p>GPA: {{ edu.cumulative_gpa }}</p>{% endif %}
                                                        {% if edu.relevant_coursework %}
                                                            <p>Relevant Coursework: {{ edu.relevant_coursework | join(', ') }}</p>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if info.experience %}
                                        <div class="info-section">
                                            <h5>Experience</h5>
                                            <ul>
                                                {% for exp in info.experience %}
                                                    <li>
                                                        <strong>{{ exp.title if exp.title else 'N/A' }}</strong> at {{ exp.company if exp.company else 'N/A' }}
                                                        {% if exp.duration %}({{ exp.duration }}){% endif %}
                                                        {% if exp.location %}, {{ exp.location }}{% endif %}
                                                        {% if exp.description %}
                                                            <ul>
                                                                {% for desc_item in exp.description %}
                                                                    <li>{{ desc_item }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if info.skills %}
                                        <div class="info-section">
                                            <h5>Skills</h5>
                                            <p>{{ info.skills | join(', ') }}</p>
                                        </div>
                                        {% endif %}

                                        {% if info.projects %}
                                        <div class="info-section">
                                            <h5>Projects</h5>
                                            <ul>
                                                {% for proj in info.projects %}
                                                    <li>
                                                        <strong>{{ proj.title if proj.title else 'N/A' }}</strong>
                                                        {% if proj.link %}<a href="{{ proj.link }}" target="_blank" class="text-link">{{ proj.link }}</a>{% endif %}
                                                        {% if proj.description %}
                                                            <ul>
                                                                {% for desc_item in proj.description %}
                                                                    <li>{{ desc_item }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        {% endif %}
                                                    
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if info.certificates %}
                                        <div class="info-section">
                                            <h5>Certificates</h5>
                                            <ul>
                                                {% for cert in info.certificates %}
                                                    <li>{{ cert }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if info.achievments %}
                                        <div class="info-section">
                                            <h5>Achievements</h5>
                                            <ul>
                                                {% for achievement in info.achievments %}
                                                    <li>{{ achievement }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if info.memberships %}
                                        <div class="info-section">
                                            <h5>Memberships</h5>
                                            <ul>
                                                {% for member in info.memberships %}
                                                    <li>
                                                        <strong>{{ member.name if member.name else 'N/A' }}</strong>
                                                        {% if member.duration %}({{ member.duration }}){% endif %}
                                                        {% if member.location %}, {{ member.location }}{% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}

                                        {% if info.campus_involvement %}
                                        <div class="info-section">
                                            <h5>Campus Involvement</h5>
                                            <ul>
                                                {% for involvement in info.campus_involvement %}
                                                    <li>
                                                        <strong>{{ involvement.name if involvement.name else 'N/A' }}</strong>
                                                        {% if involvement.duration %}({{ involvement.duration }}){% endif %}
                                                        {% if involvement.location %}, {{ involvement.location }}{% endif %}
                                                        {% if involvement.description %}
                                                            <ul>
                                                                {% for desc_item in involvement.description %}
                                                                    <li>{{ desc_item }}</li>
                                                                {% endfor %}
                                                            </ul>
                                                        {% endif %}
                                                    </li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    <button id="nextCardBtn" class="carousel-nav-btn next-btn {% if applications|length <= 1 %}hidden{% endif %}">
                        Next 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5L21 12m0 0l-7.5 7.5M21 12H3" />
                        </svg>
                    </button>
                </div>
            {% else %}
                <div class="empty-state fade-in">
                    <p>You have not submitted any applications yet.</p>
                    <a href="{{ url_for('candidate_apply') }}" class="btn-primary">
                        Apply for a Job
                    </a>
                </div>
            {% endif %}
        </main>

        <div id="examModal" class="modal hidden">
            <div class="modal-content">
                <span class="close-button" id="closeModalBtn">&times;</span>
                <h2>Technical Exam</h2>
                <form id="examForm">
                    <input type="hidden" id="modalJobId">
                    <input type="hidden" id="modalCandidateId">
                    <div id="questionsContainer">
                        
                    </div>
                    <div class="modal-buttons">
                        <button type="button" id="cancelExamBtn" class="btn-cancel">
                            Cancel
                        </button>
                        <button type="submit" id="submitExamBtn" class="btn-submit-modal">
                            Submit Exam
                        </button>
                    </div>
                </form>
                <div id="examMessageBox" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
    let applicationCards = [];
    let currentCardIndex = 0;

    // --- Card Carousel Navigation ---
    function showCard(index) {
        if (applicationCards.length === 0) return;

        applicationCards.forEach(card => {
            card.classList.remove('active');
            card.classList.add('hidden');
        });

        applicationCards[index].classList.remove('hidden');
        applicationCards[index].classList.add('active');

        const prevBtn = document.getElementById('prevCardBtn');
        const nextBtn = document.getElementById('nextCardBtn');

        if (prevBtn) {
            prevBtn.classList.toggle('hidden', index === 0);
        }
        if (nextBtn) {
            nextBtn.classList.toggle('hidden', index === applicationCards.length - 1);
        }
    }

    function nextCard() {
        if (currentCardIndex < applicationCards.length - 1) {
            currentCardIndex++;
            showCard(currentCardIndex);
        }
    }

    function prevCard() {
        if (currentCardIndex > 0) {
            currentCardIndex--;
            showCard(currentCardIndex);
        }
    }

    // --- Collapsible Sections Logic ---
    function toggleCollapsible(header) {
        header.classList.toggle('active');
        const content = header.nextElementSibling;
        if (content.classList.contains('hidden')) {
            content.classList.remove('hidden');
            content.classList.add('visible');
        } else {
            content.classList.remove('visible');
            content.classList.add('hidden');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Initialize carousel cards
        applicationCards = document.querySelectorAll('.application-card');
        if (applicationCards.length > 0) {
            showCard(currentCardIndex);
        }

        // Attach carousel navigation
        const prevBtn = document.getElementById('prevCardBtn');
        const nextBtn = document.getElementById('nextCardBtn');
        if (prevBtn) prevBtn.addEventListener('click', prevCard);
        if (nextBtn) nextBtn.addEventListener('click', nextCard);

        // Attach collapsible headers
        const collapsibleHeaders = document.querySelectorAll('.collapsible-header');
        collapsibleHeaders.forEach(header => {
            header.addEventListener('click', function() {
                toggleCollapsible(this);
            });
        });

        // --- MODIFIED: "Take Exam" Button Logic (Redirects Directly to the page) ---
        document.querySelectorAll('.btn-take-exam').forEach(button => {
            button.addEventListener('click', function() {
                const jobId = this.dataset.jobId;
                const candidateId = this.dataset.candidateId;
                
                console.log(`DEBUG: Take Exam button clicked! Job ID: ${jobId}, Candidate ID: ${candidateId}`);

                if (jobId && candidateId) {
                    // Correctly form the URL with query parameters for the /get_exam route
                    // This will cause a FULL PAGE REDIRECTION, NOT an AJAX call
                    const examUrl = `/get_exam?job_id=${jobId}&candidate_id=${candidateId}`;
                    window.location.href = examUrl; // Perform the redirection
                } else {
                    alert('Error: Missing job or candidate ID for the exam link.');
                    console.error('ERROR: Missing data-job-id or data-candidate-id on Take Exam button.');
                }
            });
        });

        // --- REMOVED: All Exam Modal related JavaScript ---
        // The exam modal, fetching questions, and submission logic now belong SOLELY to the get_exam.html page.
        // All related variables (examModal, examQuestionsDiv, submitExamBtn, etc.) and functions (closeExamModal, displayExamQuestions, showMessage)
        // that were previously in client_portal.html are now removed from here.
    });
</script>
</body>
</html>