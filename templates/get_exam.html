<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JobStir - Technical Assessment</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/get_exam.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22 color=%22white%22>JB</text></svg>" />
<script async src="https://www.googletagmanager.com/gtag/js?id=G-X4H5RPBG76"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-X4H5RPBG76');

  // Send a test event after page loads
  window.addEventListener("load", function () {
    gtag('event', 'resume_upload_test', {
      method: 'manual_trigger',
      page_location: window.location.href,
      page_title: document.title
    });
    console.log("âœ… Test event 'resume_upload_test' sent to GA");
  });
</script>

</head>
<body>
    <header class="top-nav">
        <div class="container nav-content">
            <div class="logo"><a href="{{ url_for('index') }}">JOBSTIR</a></div>
            <nav class="main-nav">
                {% if session.get('user_info') %}
                    <a href="{{ url_for('evaluate_resume') }}"><b>Evaluate Resume</b></a>
                    {% if session.user_info.is_hr %}
                        <a href="{{ url_for('hr_dashboard') }}">HR Dashboard</a>
                    {% else %}
                        <a href="{{ url_for('client_portal') }}">My Applications</a>
                    {% endif %}
                {% endif %}
                <div class="auth-links">
                    {% if session.get('user_info') %}
                        <a href="{{ url_for('logout') }}">Logout ({{ session.user_info.email }})</a>
                    {% else %}
                        <a href="{{ url_for('login') }}">Login</a>
                        <a href="{{ url_for('signup') }}">Signup</a>
                    {% endif %}
                </div>
            </nav>
        </div>
    </header>

    <main class="container main-content">
        <h1 class="page-title">Technical Assessment</h1>
        <p class="subtitle">Job: <strong>{{ job_title }}</strong></p>
        
        <div id="examMessageBox" class="message-box hidden"></div>

        <div class="exam-form-container data-card">
            <form id="exam-form">
                <div id="questionsContainer">
                    </div>
                <div class="form-actions">
                    <button type="submit" id="submitExamBtn" class="btn-primary">
                        <span class="btn-text">Submit Exam</span>
                        <span class="btn-spinner hidden"></span>
                    </button>
                </div>
            </form>
        </div>
    </main>

    <footer class="footer-bar">
        <div class="container">
            <p>&copy; 2025 JOBSTIR - All rights reserved.</p>
        </div>
    </footer>

    <script id="exam-data" type="application/json">
        {
            "questions": {{ exam_questions_json | safe }},
            "jobId": "{{ job_id }}",
            "applicationId": "{{ candidate_id }}"
        }
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const examForm = document.getElementById('exam-form');
            const questionsContainer = document.getElementById('questionsContainer');
            const examMessageBox = document.getElementById('examMessageBox');
            const submitBtn = document.getElementById('submitExamBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnSpinner = submitBtn.querySelector('.btn-spinner');

            let examQuestions = [];
            let jobId = '';
            let applicationId = '';

            try {
                const dataEl = document.getElementById('exam-data');
                const data = JSON.parse(dataEl.textContent);
                examQuestions = data.questions || [];
                jobId = data.jobId;
                applicationId = data.applicationId;
            } catch (e) {
                console.error("Fatal Error: Could not parse exam data.", e);
                showMessage('Error loading exam. Please refresh or contact support.', 'error');
                return;
            }

            // Display questions
            displayExamQuestions(examQuestions);

            examForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                setLoadingState(true);

                try {
                    const answers = getAnswersFromForm();
                    const response = await submitAnswers(answers);
                    
                    // --- IMPROVEMENT: Display styled success message instead of alert ---
                    const totalPossibleScore = examQuestions.reduce((sum, q) => sum + (q.score_possible || 10), 0);
                    const successMessage = `${response.message} Your score: ${response.score}/${totalPossibleScore}`;
                    showMessage(successMessage, 'success');
                    
                    // Redirect after a short delay
                    setTimeout(() => {
                        window.location.href = "{{ url_for('client_portal') }}";
                    }, 2500);

                } catch (error) {
                    // --- IMPROVEMENT: Display styled error message instead of alert ---
                    showMessage(error.message, 'error');
                    setLoadingState(false);
                }
            });

            function getAnswersFromForm() {
                const answers = [];
                const textareas = document.querySelectorAll('#questionsContainer textarea');
                let allAnswered = true;
                textareas.forEach(textarea => {
                    if (!textarea.value.trim()) {
                        allAnswered = false;
                    }
                    answers.push({
                        question_id: textarea.dataset.questionId,
                        answer: textarea.value
                    });
                });
                if (!allAnswered) {
                    throw new Error('Please answer all questions before submitting.');
                }
                return answers;
            }

            async function submitAnswers(answers) {
                const response = await fetch(`/submit_exam/${jobId}/${applicationId}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ answers })
                });
                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'An unknown error occurred during submission.');
                }
                return result;
            }

            function displayExamQuestions(questions) {
                if (!questions || questions.length === 0) {
                    questionsContainer.innerHTML = '<p>No questions are available for this exam.</p>';
                    submitBtn.disabled = true;
                    return;
                }
                questionsContainer.innerHTML = questions.map((q, index) => `
                    <div class="question-item">
                        <label class="question-label" for="answer-${q.id}">Question ${index + 1}:</label>
                        <p class="question-text">${escapeHtml(q.question)}</p>
                        <textarea id="answer-${q.id}" class="answer-textarea" rows="6" data-question-id="${q.id}" placeholder="Type your answer here..." required></textarea>
                    </div>
                `).join('');
            }

            function setLoadingState(isLoading) {
                submitBtn.disabled = isLoading;
                btnText.textContent = isLoading ? 'Submitting...' : 'Submit Exam';
                btnSpinner.classList.toggle('hidden', !isLoading);
            }

            function showMessage(message, type) {
                examMessageBox.textContent = message;
                examMessageBox.className = `message-box message-${type}`;
            }

            function escapeHtml(unsafe) {
                return unsafe.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
            }
        });

           document.getElementById('exam-form').addEventListener('submit', function(event) {
        event.preventDefault(); // Stop the default form submission

        const form = event.target;
        const submitButton = form.querySelector('button[type="submit"]');
        const statusDiv = document.getElementById('submission-status');

        // Disable button and show loading message
        submitButton.disabled = true;
        submitButton.textContent = 'Submitting...';
        statusDiv.textContent = '';
        statusDiv.className = '';

        // 1. Get the IDs from the hidden input fields in your form
        const jobId = form.querySelector('input[name="job_id"]').value;
        const candidateId = form.querySelector('input[name="candidate_id"]').value;

        // 2. Construct the CORRECT URL with the IDs in the path
        const submitUrl = `/submit_exam/${jobId}/${candidateId}`;

        // 3. Collect all the answers
        const answers = [];
        const textareas = form.querySelectorAll('textarea[name^="answer_"]');
        textareas.forEach(textarea => {
            const questionId = textarea.name.split('_')[1];
            answers.push({
                question_id: questionId,
                answer: textarea.value
            });
        });

        // 4. Send the data using the correct URL
        fetch(submitUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ answers: answers }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                statusDiv.textContent = 'Success! ' + data.message;
                statusDiv.className = 'alert alert-success';
                submitButton.textContent = 'Submitted!';
                // Optionally redirect after a delay
                setTimeout(() => {
                    window.location.href = '/client_portal';
                }, 3000);
            } else {
                throw new Error(data.error || 'An unknown error occurred.');
            }
        })
        .catch((error) => {
            statusDiv.textContent = 'Error: ' + error.message;
            statusDiv.className = 'alert alert-danger';
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Exam';
        });
    });
    </script>
</body>
</html>