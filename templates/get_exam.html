<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JOBSTIR - Take Your Exam</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/get_exam.css') }}"> {# We'll create this CSS next #}
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="{{ url_for('static', filename='images/founder1.png') }}" type="image/png">
</head>
<body>
    <header class="top-nav">
        <div class="container nav-content">
            <div class="logo">JOBSTIR</div>
            <nav class="main-nav">
                {% if current_user.is_authenticated %}
                    <a href="{{ url_for('evaluate_resume') }}"><b>Evaluate Resume</b></a>
                    {% if current_user.is_hr %}
                        <a href="{{ url_for('hr_dashboard') }}">HR Dashboard</a>
                        <a href="{{ url_for('hr_job_upload') }}">Upload Job</a>
                    {% else %}
                        <a href="{{ url_for('candidate_apply') }}">Apply for Job</a>
                        <a href="{{ url_for('client_portal') }}">My Applications</a>
                    {% endif %}
                {% endif %}
                <div class="auth-links">
                    {% if current_user.is_authenticated %}
                        <a href="{{ url_for('logout') }}">Logout ({{ current_user.username }})</a>
                    {% else %}
                        <a href="{{ url_for('login') }}">Login</a>
                        <a href="{{ url_for('signup') }}">Signup</a>
                    {% endif %}
                </div>
            </nav>
        </div>
    </header>

<div id="examMessageBox" class="message-box hidden"></div>
    <main class="container main-content">
        <h1 class="page-title">Online Assessment</h1>
        <p class="subtitle">Job: <strong>{{ job_title }}</strong></p>
        <p class="subtitle">Candidate: <strong>{{ candidate_name }}</strong></p>

        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container">
                    <ul class="flashes">
                        {% for category, message in messages %}
                            <li class="flash-message {{ category }}">{{ message }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}
        {% endwith %}

        <div class="exam-form-container data-card">
            <form id="exam-form">
                <input type="hidden" id="modalJobId" name="job_id" value="">
                <input type="hidden" id="modalCandidateId" name="candidate_id" value="">
                <div id="questionsContainer"></div>
                <div class="form-actions">
                    <button type="submit" class="btn-primary">Submit Exam</button>
                </div>
            </form>
        </div>
    </main>

    <footer class="footer-bar">
        <div class="container">
            <p>&copy; 2025 JOBSTIR - AI Resume Evaluator. All rights reserved.</p>
        </div>
    </footer>


<!-- Place this before the closing </body> tag -->
<script id="exam-questions-data" type="application/json">
{{ exam_questions_json | safe }}
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const examForm = document.getElementById('exam-form');
    const questionsContainer = document.getElementById('questionsContainer');
    const examMessageBox = document.getElementById('examMessageBox');

    // Get exam questions with proper error handling
    const examQuestionsDataElement = document.getElementById('exam-questions-data');
    let examQuestions = [];
    
    if (examQuestionsDataElement) {
        try {
            const parsedData = JSON.parse(examQuestionsDataElement.textContent);
            // Handle both array format and {questions: []} format
            examQuestions = Array.isArray(parsedData) ? parsedData : (parsedData.questions || []);
            console.log("DEBUG: Successfully parsed exam JSON from hidden element.");
        } catch (e) {
            console.error("ERROR: Failed to parse exam JSON from hidden element:", e);
            showMessage('Error loading exam questions. Please refresh the page or contact support.', 'error', examMessageBox);
        }
    } else {
        console.error("ERROR: Could not find exam questions data element");
        showMessage('Error loading exam questions. Please refresh the page or contact support.', 'error', examMessageBox);
    }
    
    const jobId = "{{ job_id }}";
    const candidateId = "{{ candidate_id }}";

    // Set hidden field values
    if (document.getElementById('modalJobId')) {
        document.getElementById('modalJobId').value = jobId;
    }
    if (document.getElementById('modalCandidateId')) {
        document.getElementById('modalCandidateId').value = candidateId;
    }

    // Display questions
    displayExamQuestions(examQuestions);

    // Handle form submission
    if (examForm) {
        examForm.addEventListener('submit', async function(event) {
            event.preventDefault();

            const submitBtn = examForm.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const answers = Array.from(document.querySelectorAll('#questionsContainer textarea')).map(textarea => ({
                    question_id: textarea.dataset.questionId,
                    answer: textarea.value
                }));

                if (!answers.every(a => a.answer.trim())) {
                    throw new Error('Please answer all questions before submitting.');
                }

                const response = await fetch(`/submit_exam/${jobId}/${candidateId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ answers })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(`${result.message} Your total score: ${result.score}/30`);
                    window.location.href = "{{ url_for('client_portal') }}";
                } else {
                    throw new Error(result.error || 'Something went wrong during submission.');
                }
            } catch (error) {
                console.error('Submission error:', error);
                alert(error.message || 'Network error during submission. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Exam';
            }
        });
    }

    function displayExamQuestions(questions) {
        questionsContainer.innerHTML = '';
        
        if (!questions?.length) {
            questionsContainer.innerHTML = '<p class="text-gray-600 text-center">No questions available for this exam.</p>';
            return;
        }

        questions.forEach((q, index) => {
            const questionHtml = `
                <div class="question-item">
                    <p class="question-number">Question ${index + 1}:</p>
                    <p class="question-text">${escapeHtml(q.question)}</p>
                    <textarea 
                        class="answer-textarea" 
                        rows="6" 
                        data-question-id="${escapeHtml(q.id)}" 
                        placeholder="Type your answer here..."
                    ></textarea>
                </div>
            `;
            questionsContainer.insertAdjacentHTML('beforeend', questionHtml);
        });
        console.log("Questions displayed.");
    }

    function showMessage(message, type, targetElement) {
        if (targetElement) {
            targetElement.textContent = message;
            targetElement.className = '';
            targetElement.classList.add('message-box', `message-${type}`);
            targetElement.classList.remove('hidden');
        }
    }

    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
});
</script>

</body>
</html>